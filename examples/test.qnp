import "std.qnp"

void printBlockList():
	std::print("ChunkList:\n")
	std::__MemBlockHeader* curr = std::__memBlocks
	while curr != null:
		std::print(" This: ")
		std::print((u64)curr)

		std::print("\n Prev: ")
		std::print((u64)curr->prev)

		std::print("\n Next: ")
		std::print((u64)curr->next)

		std::print("\n Size: ")
		std::print(curr->sizeAvail)

		std::print("\n DiffToPrev: ")
		if curr->prev != null:
			std::print((u64)curr - (u64)curr->prev)
		else:
			std::print("--")

		std::print("\n DiffToNext: ")
		if curr->next != null:
			std::print((u64)curr->next - (u64)curr)
		else:
			std::print("--")

		std::print("\n\n")
		curr = curr->next
	std::print("-----------------\n")

i64 brkDiff():
	static i64 lastBrk = 0
	i64 currBrk = std::__brk(0)
	i64 diff = currBrk - lastBrk
	lastBrk = currBrk
	return diff
brkDiff()

void printBrkDiff():
	std::print("BrkDiff: ")
	std::print(brkDiff())
	std::print("\n")

printBlockList()

std::print("Allocating 100 bytes\n")
void* buff1 = std::malloc(100)
printBrkDiff()
printBlockList()
std::print("Allocating 10000 bytes\n")
void* buff2 = std::malloc(10000)
printBrkDiff()
printBlockList()

std::print("Freeing 100 bytes\n")
std::free(buff1)
printBrkDiff()
printBlockList()

std::print("Freeing 10000 bytes\n")
std::free(buff2)
printBrkDiff()
printBlockList()

std::print("Allocating 12000 bytes\n")
buff1 = std::malloc(12000)
printBrkDiff()
printBlockList()

std::print("Freeing 12000 bytes\n")
std::free(buff1)
printBrkDiff()
printBlockList()

std::print("Allocating 1024 megabytes...")
buff1 = std::malloc(1024 * 1024 * 1024)
std::print(" DONE\n")
printBrkDiff()
printBlockList()

std::print("Clearing buff1... ")
std::memset(buff1, 0, 1024 * 1024 * 1024)
std::print(" DONE\n")

u8* str = "ABCDEFGHIJKLMNOPQRSTUVWXYZ\n"
std::memset(str, 'A', 9)
std::print(str)
std::print("-----------------\n")

std::print("Freeing 1024 megabytes...")
std::free(buff1)
std::print(" DONE\n")
printBrkDiff()
printBlockList()
